@page "/products/active"
@rendermode InteractiveWebAssembly
@using WP.Web.Client.Models
@using WP.Web.Client.Services
@using WP.Web.Client.Components
@inject ICatalogService CatalogService
@inject NavigationManager Navigation

<PageTitle>Active Products</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-check-circle text-success"></i> Active Products</h2>
        <button class="btn btn-primary" @onclick="NavigateToNewProduct">
            <i class="bi bi-plus-circle"></i> New Product
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border"></div>
        </div>
    }
    else if (products == null || !products.Any())
    {
        <div class="alert alert-info">No active products found</div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-3 g-4">
            @foreach (var product in products)
            {
                <div class="col">
                    <ProductCard Product="@product" 
                                 OnView="ViewProduct" 
                                 OnEdit="EditProduct" 
                                 OnDelete="DeleteProduct" />
                </div>
            }
        </div>

        @if (pagedResult != null && pagedResult.TotalResults > pageSize)
        {
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Previous</button>
                    </li>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        var pageNumber = i;
                        <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                            <button class="page-link" @onclick="() => ChangePage(pageNumber)">@pageNumber</button>
                        </li>
                    }
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Next</button>
                    </li>
                </ul>
            </nav>
        }
    }
</div>

@code {
    private List<ProductDto> products = new();
    private PagedResult<ProductDto>? pagedResult;
    private bool isLoading = true;
    private int currentPage = 1;
    private int pageSize = 9;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        isLoading = true;
        pagedResult = await CatalogService.GetActiveProductsAsync(pageSize, currentPage);
        if (pagedResult != null)
        {
            products = pagedResult.List?.ToList() ?? new List<ProductDto>();
            totalPages = (int)Math.Ceiling((double)pagedResult.TotalResults / pageSize);
        }
        isLoading = false;
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadProducts();
    }

    private void ViewProduct(Guid id) => Navigation.NavigateTo($"/products/{id}");
    private void EditProduct(Guid id) => Navigation.NavigateTo($"/products/form/{id}");
    private void NavigateToNewProduct() => Navigation.NavigateTo("/products/form");
    private async Task DeleteProduct(Guid id)
    {
        var result = await CatalogService.DeleteProductAsync(id);
        if (result.Success) await LoadProducts();
    }
}
