@using WP.Web.Services
@implements IDisposable

@if (messages.Any())
{
    <div class="container mt-3">
        @foreach (var message in messages)
        {
            <div class="alert alert-@message.Type alert-dismissible fade show" role="alert">
                @if (message.Type == "danger")
                {
                    <button type="button" class="btn-close" @onclick="() => RemoveMessage(message.Id)"></button>
                    <h5 class="alert-heading">Oops! Something went wrong :(</h5>
                    @if (message.Details?.Any() ?? false)
                    {
                        <ul class="mb-0">
                            @foreach (var detail in message.Details)
                            {
                                <li>@detail</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="mb-0">@message.Text</p>
                    }
                }
                else
                {
                    <button type="button" class="btn-close" @onclick="() => RemoveMessage(message.Id)"></button>
                    <div>@message.Text</div>
                }
            </div>
        }
    </div>
}

@code {
    private List<AlertMessage> messages = new();
    private Timer? autoRemoveTimer;

    protected override void OnInitialized()
    {
        AlertService.OnAlertAdded += HandleAlertAdded;
    }

    private void HandleAlertAdded(AlertMessage message)
    {
        messages.Add(message);
        InvokeAsync(StateHasChanged);

        // Auto-remove after 5 seconds
        _ = Task.Run(async () =>
        {
            await Task.Delay(5000);
            RemoveMessage(message.Id);
        });
    }

    private void RemoveMessage(Guid id)
    {
        var message = messages.FirstOrDefault(m => m.Id == id);
        if (message != null)
        {
            messages.Remove(message);
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        AlertService.OnAlertAdded -= HandleAlertAdded;
        autoRemoveTimer?.Dispose();
    }

    [Inject]
    private AlertService AlertService { get; set; } = default!;
}


